{{ 'component-email-pop-up.css' | asset_url | stylesheet_tag }}
{{ 'component-modal.css' | asset_url | stylesheet_tag }}

<modal-email-sign-up id="newsletter-sign-up">
  <div
    role="dialog"
    aria-live="assertive"
    aria-modal="true"
    aria-labelledby="modal-title"
    id="buy-near-me-modal"
    aria-hidden="true"
    class="modal  modal-email"
    data-section-id="{{ section.id }}"
    data-email-popup
    data-frequency="{{ settings.pop_up_frequency }}"
  >
    <div class="modal__cover" data-close-modal aria-hidden="true"></div>

    <div class="modal__inner">
      <div class="modal__close">
        <button aria-label="Close Modal" data-modal-close>
          <span class="button__text">Close</span>
          <span class="button__decorative-elem"></span>
        </button>
      </div>
      <div class="modal__content modal-email__content">
        <div class="">
          <img
            srcset="
                {%- if settings.email_popup_image_small.width >= 165 -%}
                  {{ image | image_url: width: 165 }} 165w,{%- endif -%}
                {%- if settings.email_popup_image_small.width >= 360 -%}
                  {{ image | image_url: width: 360 }} 360w,{%- endif -%}
                {%- if settings.email_popup_image_small.width >= 533 -%}
                  {{ image | image_url: width: 533 }} 533w,{%- endif -%}
                {%- if settings.email_popup_image_large.width >= 720 -%}
                  {{ image | image_url: width: 720 }} 720w,{%- endif -%}
                  {%- if settings.email_popup_image_large.width >= 800 -%}
              {{ image | image_url: width: 800 }} 800w,{%- endif -%}
                {{ image | image_url }} {{ settings.email_popup_image_large.width }}w
            "
            src="{{ image | image_url: width: 100, height: 100, width: 200 }}"
            sizes="(min-width: 1200px) 35vw, (min-width: 940px) 30vw, 90vw"
            alt="{{ settings.email_popup_image_small.alt | escape }}"
            class="motion-reduce responsive-image"
            aria-hidden="true"
            loading="lazy"
            width="{{ settings.email_popup_image_small.width }}"
            height="{{ settings.email_popup_image_small.height }}"
          >
        </div>
        <h1 id="modal-title" class="modal-email__headline">{{ settings.email_popup_headline }}</h1>
        <div>
          <div class="modal-email__body">
            <p>
              {{ settings.email_popup_body }}
            </p>
          </div>

          <form action="" class="modal-email__form">
            <div class="form-section">
              <custom-input-wrapper class="custom-field">
                <label for="email-newsletter">Your Email</label>

                <input type="email" id="email-newsletter" name="email" required>
              </custom-input-wrapper>

              <button type="submit" class="button button--primary  button--medium">
                {{ settings.email_popup_button_cta }}
              </button>
            </div>
          </form>
          <div class="modal-email__disclaimer">
            {{ settings.email_popup_secondary_body }}
          </div>
        </div>
      </div>
    </div>
  </div>
</modal-email-sign-up>

{% javascript %}
  class ModalEmailSignUp extends GlobalModal {
    constructor() {
      super();

      // Get data attributes
      this.popUpFrequency = this.dataset.frequency;
      this.modalSessionCookie = 'first-time-visitor-saw-pop-up';

      // Selectors
      this.selectors = {
        modalClose: '[data-close-modal]',
        emailPopup: '[data-email-popup]',
        emailPopUpImg: '[data-email-popup-image]',
        signUpButton: '[data-sign-up-button]',
        hideOnSubmit: '[data-hide-on-submit]',
      };

      // Event listener for the custom element
      this.addEventListener('click', (event) => {
        if (event.target.dataset.emailPopup) {
          this.showEmailPopup();
        }
      });

      // Initialize the popup after the element is created
      this.initPopup();
    }

    initPopup() {
      // Check if the user has already seen the popup
      if (this.checkPopupDisplay()) {
        console.log('already seen');
        return;
      }

      // Show the popup after a delay (4000ms in this case)
      setTimeout(() => {
        console.log('display');
        this.showEmailPopup();
      }, 1000);
    }

    checkPopupDisplay() {
      return false;
      if (this.popUpFrequency === 'first-timers-only') {
        return localStorage.getItem(this.modalSessionCookie);
      } else {
        return sessionStorage.getItem(this.modalSessionCookie);
      }
    }

    showEmailPopup() {
      if (this.popUpFrequency === 'first-timers-only') {
        sessionStorage.removeItem(this.modalSessionCookie);
        localStorage.setItem(this.modalSessionCookie, 'true');
      } else {
        sessionStorage.setItem(this.modalSessionCookie, 'true');
        localStorage.removeItem(this.modalSessionCookie);
      }

      this.animCtrl = null;
      this.imageEntryAnim = null;

      this.openModal();

      //   document.querySelector(this.selectors.modalClose).addEventListener('click', (event) => {
      //     if (event.target === event.currentTarget) {
      //       this.hideEmailPopup();
      //     }
      //   });
    }

    setUpPopup() {
      const form = document.querySelector('[data-newsletter-form]');

      if (form) {
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          this.handleFormSubmit(form);
        });
      }
    }

    handleFormSubmit(form) {
      setTimeout(() => {
        const successResponse = document.querySelector('#mce-success-response');
        if (successResponse && this.checkIfFormFilled(form)) {
          const hideOnSubmitElements = document.querySelectorAll(this.selectors.hideOnSubmit);
          hideOnSubmitElements.forEach((element) => {
            element.style.display = 'none';
          });
          successResponse.style.margin = '0';
        }
      }, 200);
    }

    checkIfFormFilled(form) {
      return form.checkValidity();
    }
  }

  // Define the custom HTML element
  customElements.define('modal-email-sign-up', ModalEmailSignUp);
{% endjavascript %}
